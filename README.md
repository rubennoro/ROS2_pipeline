# Steps for Running & Setting up Pipeline (Skip to 5c if second time)

## 1. EasyCAT Setup (You can test with existing files in Github Repo, but recommended to follow this step to create new ones)

1. Connect the EasyCAT to the Arduino Giga
    1. Power on the Arduino Giga with a computer
    2. Attach ethernet to EasyCAT and computer
2. Git clone the [EasyCAT folder](https://github.com/dslemusp/EasyCAT/tree/master) for configuration and testing
3. Git clone the VN200-Pipeline repo for the existing Arduino programs and EasyCAT configuration
4. For getting a new xml file, open the configurator.exe GUI, click project, and open the github repository .prj file
5. Click create to generate new .h, .prj. and .xml
6. Click write EEPROM, and open the bin file in the folder section
7. Make sure to save the specific files generated by this 

## 2. Arduino Giga Setup

1. Replace the EasyCAT files from the Github Repo for VN-200 Pipeline with the files generated in EasyCAT setup steps
2. Open the t3pipeline.ino and husky_m4.ino files in Arduino IDE
    1. For t3pipeline.ino
        1. In the IDE, split the memory into 1MB + 1MB for M7 and M4 
        2. Set this to load to the main processor (M7)
    2. For husky_m4.ino
        1. In the IDE, split the memory into 1MB + 1MB for M7 and M4
        2. Set this to load to the co-processor (M4)

## 3. VN-200 IMU Setup

1. Connect Pins of VN-200 IMU to EasyCAT shield pins
    1. 5V to Red wire
    2. GND to Black wire
    3. TX to Purple Wire
    4. RX to Orange wire

## 4. Motive Software Setup for Dronecage

1. Turn on the Dronecage cameras, wait for the lights above the ethernet connections to enable
2. Open motive software on the main computer
3. Place a rigid body / the robot in the drone cage
4. Create a rigid body, name it opti_test
5. Change computer WiFi to DRONECAGE 
    1. check that ipv4 is 192.168.0.2 with ipconfig command in command prompt
6. In settings, go to streaming
    1. Enable VRPN
7. Set desired Hz transmission

## 5. NVIDIA Jetson Setup

### a) Create Docker Container (can skip to 5b if using an existing Container)

On Nvidia Jetson:

1. Open a container from the jetson_image2 docker image
    1. Can check this with sudo docker image ls
    2. sudo docker run -it —privileged —net=host —device=/dev/ttyACM0 —name <container_name> <image_name> (jet_optiMain jetson_image2)
2. Automatically cd’s into husky_ws, go back one place into home directory
    1. cd ..
3. Using ethernet connection, clone ROS2_pipeline github repo
    1. git clone https://github.com/rubennoro/ROS2_pipeline.git
4. Need to install several packages for running VRPN & Sending serial data
    1. sudo apt install ros-humble-vrpn
    2. sudo apt install python3-serial
    3. sudo apt install python3-smbus
5. After installation, cd into ROS2_pipeline/src
    1. colcon build (ignore warnings)
    2. source install/setup.bash
6. To ensure connection takes place, need to type this into terminal

**cat <<EOF > /etc/protocols**

**ip 0 IP**

**icmp 1 ICMP**

**tcp 6 TCP**

**udp 17 UDP**

**EOF** 

1. Before starting launching the vrpn client, need to set frequency
    1. cd /home/ROS2_pipeline/src/vrpn_mocap/config
    2. nano client.yaml
    3. Set the frequency to a desired value, and you need to synchronize this with Motive
2. Exit out of the created container
3. Attach Wifi USB and connect to DroneCage Wifi
4. *Connect the Arduino Giga to the Jetson
    1. Must be done for ls -l /dev/ttyACM0 to appear
    2. Ensure blue light on Arduino is illuminated
5. Open two terminals with the docker container
    1. sudo docker start -ai <container_name>
    2. sudo docker exec -it <container_name> bash
6. In each terminal, cd .. and cd ROS2_pipeline
    1. Run source install/setup.bash to access steps below
7. For opti-track ros topic position data publishing
`ros2 launch vrpn_mocap client.launch.yaml server:=<server ip> port:=<port>`
    1. ensure this works, with <server ip> at 192.168.0.2 and <port> 3883
8. ros2 run opti_track opti_data_sub
9. For all following uses, visit 5c instead

### c) Using Existing Container

1. Attach Wifi USB and connect to DroneCage Wifi
2. *Connect the Arduino Giga to the Jetson before entering a container
    1. Must be done for ls -l /dev/ttyACM0 to appear
3. Open two terminals with the docker container
    1. sudo docker start -ai <container_name>
    2. sudo docker exec -it <container_name> bash
    3. **<container_name> = <jet_optiMAIN> for existing usage**
4. In each terminal, cd .. and cd ROS2_pipeline
    1. Run source install/setup.bash to access steps below
5. For opti-track ros topic position data publishing
`ros2 launch vrpn_mocap client.launch.yaml server:=<server ip> port:=<port>`
    1. ensure this works, with <server ip> at 192.168.0.2 and <port> 3883
6. ros2 run opti_track opti_data_sub
